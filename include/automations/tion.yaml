# Can be problem, if tion is still online and next automation will trigger
- alias: Tion poweroff on AC loss
  trigger:
    platform: state
    entity_id: binary_sensor.mega_2_ac
    to: 'off'
  action:
    service: input_boolean.turn_off
    entity_id: input_boolean.tion_power

- alias: Tion send power command on power switch change
  trigger:
    platform: state
    entity_id: input_boolean.tion_power
  action:
    service: rest_command.tion_remote
    data:
      button: 'POWER'

- alias: Tion send up-down command on fan speed change
  mode: queued
  trigger:
    platform: state
    entity_id: input_number.tion_fan_speed
  action:
    - repeat:
        count: "{{ (trigger.from_state.state | int - trigger.to_state.state | int) | abs + 1 }}"
        sequence:
          - service: rest_command.tion_remote
            data:
              button: "{% if (trigger.from_state.state | int - trigger.to_state.state | int) > 0 %}DOWN{% else %}UP{% endif %}"
          - delay: '00:00:01'

- alias: Tion power on
  trigger:
    platform: state
    entity_id: sensor.room_1_co2
  condition:
    - "{{ is_state('input_boolean.tion_auto', 'on') }}"
    - "{{ is_state('input_boolean.tion_power', 'off') }}"
    - "{{ trigger.to_state.state | int >  900 }}"
    - "{{ ( as_timestamp(now()) - as_timestamp(state_attr('automation.tion_power_on', 'last_triggered')) |int(0) ) > 540 }}"
    - "{{ ( as_timestamp(now()) - as_timestamp(state_attr('automation.tion_power_off', 'last_triggered')) |int(0) ) > 540 }}"
  action:
    - service: input_boolean.turn_on
      entity_id: input_boolean.tion_power
    - service: input_number.set_value
      data:
        entity_id: input_number.tion_fan_speed
        value: 1

- alias: Tion power off
  trigger:
    platform: state
    entity_id: sensor.room_1_co2
  condition:
    - "{{ is_state('input_boolean.tion_auto', 'on') }}"
    - "{{ is_state('input_boolean.tion_power', 'on') }}"
    - "{{ trigger.to_state.state | int <  900 }}"
    - "{{ ( as_timestamp(now()) - as_timestamp(state_attr('automation.tion_power_on', 'last_triggered')) |int(0) ) > 540 }}"
    - "{{ ( as_timestamp(now()) - as_timestamp(state_attr('automation.tion_power_off', 'last_triggered')) |int(0) ) > 540 }}"
  action:
    service: input_boolean.turn_off
    entity_id: input_boolean.tion_power

- alias: Tion auto speed
  trigger:
    platform: state
    entity_id: sensor.room_1_co2
  condition:
    - "{{ is_state('input_boolean.tion_auto', 'on') }}"
    - "{{ is_state('input_boolean.tion_power', 'on') }}"
    - "{{ trigger.to_state.state | int >  900 }}"
  action:
    service: input_number.set_value
    data:
      entity_id: input_number.tion_fan_speed
      value: "{% set v = trigger.to_state.state | int %}{%if v < 1000%}1{%elif v < 1100%}2{%elif v < 1200%}3{%elif v < 1200%}4{%endif%}"
